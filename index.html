<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chalo Â· FreshCo â€” PLU Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#c7e21c" />

  <!-- Force LIGHT controls/appearance everywhere -->
  <meta name="color-scheme" content="light" />
  <style>:root{ color-scheme: light; }</style>

  <!-- Make iOS PWA status bar use the light style (dark text) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />

  <style>
    /* ===== base ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { min-height: 100dvh; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background:#c7e21c; /* LIGHT, forced */
      color:#0f0f0f;
      padding-top:72px; /* disabled in A2HS */
    }
    img{ max-width:100%; height:auto; display:block; }
    button, input{ font: inherit; }
    input, textarea, select { font-size:16px; caret-color:auto; }
    input, button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    /* a11y */
    .sr-only{
      position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
    :focus-visible{ outline:3px solid #7aa7ff; outline-offset:2px; border-radius:10px; }

    /* header (fixed normally; NOT fixed in A2HS) */
    .brandbar{
      position:fixed; top:0; left:0; right:0; z-index:9999;
      min-height:72px;
      padding: calc(12px + env(safe-area-inset-top, 0px)) 16px 12px;
      background:#111; color:#fff; box-shadow:0 2px 0 rgba(0,0,0,.2);
    }
    .brandbar__inner{ display:flex; align-items:center; justify-content:center; min-height:72px; }
    .brandbar__logo img{ height:70px; width:auto; display:block; }

    /* app shell */
    .appwrap{ max-width:640px; margin:10px auto 22px; padding:12px; }
    .appcard{ background:#fff; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:12px; }

    /* search */
    .bar{ position:sticky; top:72px; z-index:40; background:transparent; padding-top:2px; }
    .searchwrap{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; }
    form { margin:0; }

    #query{
      width:100%; height:52px; border-radius:999px;
      border:1.5px solid rgba(0,0,0,.10); background:#fff;
      padding:0 14px; line-height:1; outline:none;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      background-image:none!important;
      color:#111;
    }
    #query:focus{ border-color:rgba(0,0,0,.24); }

    #btn{
      width:44px;height:44px;border-radius:999px;border:0;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:0; box-shadow:0 2px 8px rgba(0,0,0,.12);
      background:#fff; color:#111; border:1.5px solid rgba(0,0,0,.10);
    }
    #btn::before{ content:"ðŸ”Ž"; font-size:18px; }
    #btn:active{ transform:scale(.98); }

    /* results */
    .result{ margin-top:12px; }
    .result ul{ list-style:none; padding:0; margin:12px 0 0; }
    .result li.card{
      display:grid; grid-template-columns:64px 1fr; gap:10px; align-items:center;
      padding:10px 8px; border-radius:14px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.08);
    }
    .result li.card + li.card{ margin-top:10px; }
    .thumb{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#f5f7f8; }
    .meta{ line-height:1.35; font-size:15px; color:#0f0f0f; }
    .meta strong{ display:block; font-weight:900; color:#0f0f0f; }
    .muted, .muted strong{ color:#707070; }

    /* wider */
    @media (min-width:420px){
      .appwrap{ padding:16px; }
      .result li.card{ grid-template-columns:72px 1fr; padding:12px; }
      .thumb{ width:72px; height:72px; border-radius:12px; }
    }

    /* ===== A2HS-only: remove fixed/sticky near the input, kill transforms/fixed ancestors ===== */
    .ios-standalone .brandbar { position: static !important; }
    .ios-standalone body { padding-top: 0 !important; }
    .ios-standalone .bar { position: static !important; top:auto !important; }
    .ios-standalone .no-fixed { position: static !important; }
    .ios-standalone .no-transform { transform: none !important; }

    /* NOTE: intentionally NO dark-mode media query here to force light everywhere */
  </style>
</head>
<body>
<header class="brandbar" role="banner" aria-label="Chalo FreshCo">
  <div class="brandbar__inner">
    <a class="brandbar__logo" href="/" aria-label="Home">
      <img src="img/plu/download.png" alt="Chalo Â· FreshCo â€” PLU Lookup">
    </a>
  </div>
</header>

<main class="appwrap" role="main">
  <section class="appcard" aria-label="PLU search">
    <div class="bar">
      <form onsubmit="return false" aria-label="Search PLU">
        <div class="searchwrap">
          <label for="query" class="sr-only">Search item name or PLU</label>
          <input id="query"
                 type="text"
                 placeholder="Search item or PLU (e.g., Banana or 4011)"
                 inputmode="search"
                 enterkeyhint="search"
                 autocapitalize="none"
                 autocomplete="off"
                 aria-describedby="searchHelp" />
          <button id="btn" type="button" aria-label="Search">Search</button>
        </div>
      </form>
    </div>

    <div id="results" class="result" aria-live="polite" aria-busy="false">
      <span id="searchHelp" class="muted">Type an item or a PLU to begin.</span>
    </div>
  </section>
</main>

<script>
  /* ===== image helpers ===== */
  const IMAGE_BASE = "img/plu/";
  function slugifyName(n){return (n||"").toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')+".jpg";}
  function imgCandidates(code,name){return [IMAGE_BASE+String(code).trim()+".jpg", IMAGE_BASE+slugifyName(name)];}
  function placeholderData(text){const t=encodeURIComponent((text||"PLU").slice(0,4).toUpperCase());
    return "data:image/svg+xml;utf8,"+`<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' fill='%23f3f4f6'/><text x='50%' y='55%' text-anchor='middle' dominant-baseline='middle' font-family='system-ui,sans-serif' font-size='34' fill='%239ca3af'>${t}</text></svg>`;
  }
  window.__imgFallback = function(img){
    const alt=img.dataset.alt, ph=img.dataset.ph;
    if(!img.dataset.try2){ img.dataset.try2="1"; img.src=alt; } else { img.onerror=null; img.src=ph; }
  };

  /* ===== data (trimmed) ===== */
  var pluMap = {/* â€¦ keep your full map â€¦ */};
  var familyMap = {/* â€¦ keep your full map â€¦ */};

  /* ===== search/match utilities (unchanged) ===== */
  const aliases = {"aubergine":"eggplant","brinjal":"eggplant","courgette":"zucchini","capsicum":"pepper","bhindi":"okra","coriander":"cilantro","spring onion":"green onion","scallion":"green onion","bell pepper":"pepper","water melon":"watermelon","bread fruit":"breadfruit","dragon fruit":"dragonfruit","jack fruit":"jackfruit","star fruit":"starfruit","passion fruit":"passionfruit","custard apple":"custardapple"};
  const STOP = new Set(["the","a","for","code","plu","all","please","give","me","of","find","each","bulk","bunch","case","bag","basket","pack","pk","lb","lbs","kg","g","oz","clamshell","mini","large","small","loose","on","and"]);
  function stripDiacritics(s){return (s||"").normalize?s.normalize("NFD").replace(/[\u0300-\u036f]/g,""):s;}
  function normalize(s){return stripDiacritics(String(s||"")).toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();}
  const SING_EXCEPT=new Set(["asparagus","citrus","lettuce","bass","glass","chess"]);
  function singularize(w){if(!w)return w;if(SING_EXCEPT.has(w))return w;if(w.endsWith("ses"))return w.slice(0,-2);if(w.endsWith("ies")&&w.length>4)return w.slice(0,-3)+"y";if(w.endsWith("ss")||w.endsWith("us"))return w;if(w.endsWith("s")&&w.length>4)return w.slice(0,-1);return w;}
  function toTokens(s){let joined=normalize(s).split(" ").filter(Boolean).map(singularize).filter(t=>!STOP.has(t)).join(" ");Object.keys(aliases).forEach(k=>{const nk=normalize(k);if(joined.indexOf(nk)!==-1)joined=joined.replace(new RegExp("\\b"+nk+"\\b","g"),normalize(aliases[k]));});return joined.split(" ").filter(Boolean);}
  function soundex(word){word=normalize(word);if(!word)return"";const first=word[0].toUpperCase();const map={b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6};let out=first,prev=map[word[0]]||0;for(let i=1;i<word.length;i++){const code=map[word[i]]||0;if(code!==0&&code!==prev)out+=String(code);prev=code;}return(out+"000").slice(0,4);}
  function trigrams(s){s="  "+normalize(s)+"  ";const g={};for(let i=0;i<s.length-2;i++)g[s.slice(i,i+3)]=(g[s.slice(i,i+3)]||0)+1;return g;}
  function cosine3(a,b){const A=trigrams(a),B=trigrams(b);let dot=0,na=0,nb=0;for(const k in A){na+=A[k]*A[k];if(B[k])dot+=A[k]*A[k];}for(const k2 in B)nb+=B[k2]*B[k2];return(na&&nb)?dot/Math.sqrt(na*nb):0;}
  function editDistance(a,b){a=normalize(a);b=normalize(b);const al=a.length,bl=b.length;if(!al)return bl;if(!bl)return al;const dp=new Array((al+1)*(bl+1));const idx=(i,j)=>i*(bl+1)+j;for(let i=0;i<=al;i++)dp[idx(i,0)]=i;for(let j=0;j<=bl;j++)dp[idx(0,j)]=j;for(let i=1;i<=al;i++)for(let j=1;j<=bl;j++){const cost=a.charAt(i-1)===b.charAt(j-1)?0:1;const del=dp[idx(i-1,j)]+1,ins=dp[idx(i,j-1)]+1,sub=dp[idx(i-1,j-1)]+cost;dp[idx(al,bl)]=Math.min(del,ins,sub);}return dp[idx(al,bl)];}
  function tokenSet(str){return toTokens(str).reduce((set,t)=>(set[t]=1,set),{});}
  function phoneticSimilarity(aTokens,bTokens){if(!aTokens.length||!bTokens.length)return 0;const a=aTokens.map(soundex),b=bTokens.map(soundex);let matches=0;for(let i=0;i<a.length;i++)for(let j=0;j<b.length;j++)if(a[i]&&a[i]===b[j]){matches++;break;}return matches/Math.max(a.length,b.length);}
  function jaccard(aStr,bStr){const A=tokenSet(aStr),B=tokenSet(bStr);let inter=0,uni=0;const keys={};for(const k in A){keys[k]=1;if(B[k])inter++;}for(const k2 in B)keys[k2]=1;for(const u in keys)uni++;return uni?inter/uni:0;}
  function scoreName(name,query){const nameN=normalize(name),qN=normalize(query);if(!nameN||!qN)return 0;const sub=nameN.indexOf(qN)!==-1?1:0;const dist=editDistance(nameN,qN),maxLen=Math.max(nameN.length,qN.length);const edSim=maxLen?(1-dist/maxLen):0;const jac=jaccard(name,query);const ph=phoneticSimilarity(toTokens(name),toTokens(query));const cos=cosine3(name,query);let score=(jac*0.40)+(sub*0.25)+(ph*0.15)+(cos*0.10)+(edSim*0.10);if(nameN.startsWith(qN))score+=0.15;return score;}
  function nospace(s){return normalize(s).replace(/\s+/g,"");}
  function equalLoose(a,b){const an=normalize(a),bn=normalize(b);return(an&&bn&&an===bn)||(nospace(a)===nospace(b));}
  function scoreNameLoose(name,query){return Math.max(scoreName(name,query),scoreName(nospace(name),nospace(query)));}

  const FAMILY=(function(){const byCode=Object.create(null),toCanonical=Object.create(null);Object.keys(familyMap).forEach(code=>{const arr=familyMap[code];if(!Array.isArray(arr)||!arr[0])return;const canonical=normalize(arr[0]);byCode[code]=canonical;toCanonical[canonical]=canonical;toTokens(canonical).forEach(tok=>{toCanonical[tok]=canonical;});if(arr[1]){const plural=normalize(arr[1]);toCanonical[plural]=canonical;toTokens(plural).forEach(tok=>{toCanonical[tok]=canonical;});}
    const noSpace=canonical.replace(/\s+/g,'');toCanonical[noSpace]=canonical;});return{byCode,toCanonical};})();

  const entries=Object.keys(pluMap).map(code=>{const name=pluMap[code];const nameN=normalize(name);const tokens=toTokens(nameN);const tokSet=tokens.reduce((o,t)=>(o[t]=1,o),{});const sndx=tokens.map(soundex);return{code,name,nameN,tokens,tokSet,sndx};});
  const POSTINGS=new Map();entries.forEach((e,i)=>e.tokens.forEach(t=>{if(!POSTINGS.has(t))POSTINGS.set(t,new Set());POSTINGS.get(t).add(i);}));
  const FAMILY_INDEX=Object.create(null);entries.forEach((e,i)=>{const fam=FAMILY.byCode[e.code];if(fam){if(!FAMILY_INDEX[fam])FAMILY_INDEX[fam]=[];FAMILY_INDEX[fam].push(i);}});

  function overlapCount(aSet,bSet){let c=0;for(const k in aSet)if(bSet[k])c++;return c;}
  function fastScore(entry,qStr,qTokens,qTokSet,qSndx){const sub=entry.nameN.indexOf(qStr)!==-1?1:0;const inter=overlapCount(entry.tokSet,qTokSet);const uni=Object.keys(entry.tokSet).length+qTokens.length-inter;const jac=uni?(inter/uni):0;let phMatches=0;for(let i=0;i<entry.sndx.length;i++){const s=entry.sndx[i];for(let j=0;j<qSndx.length;j++){if(s&&s===qSndx[j]){phMatches++;break;}}}const ph=qSndx.length?(phMatches/Math.max(entry.sndx.length,qSndx.length)):0;const starts=entry.nameN.startsWith(qStr)?0.15:0;return(jac*0.55)+(sub*0.30)+(ph*0.15)+starts;}
  function inferFamily(entry){const byCodeFam=FAMILY.byCode[entry.code];if(byCodeFam)return byCodeFam;for(const t of entry.tokens){const canon=FAMILY.toCanonical[t];if(canon)return canon;}return"";}

  const cacheHTML=Object.create(null);
  function renderList(items){
    if(!items.length)return'<div><strong>No results</strong></div>';
    const lis=items.map(item=>{const [src1,src2]=imgCandidates(item.code,item.name);const ph=placeholderData(item.name);
      return `<li class="card" aria-label="${item.name}">
        <img class="thumb" src="${src1}" alt="${item.name}" loading="lazy" decoding="async"
             data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)">
        <div class="meta"><strong>${item.code} â€“ ${item.name}</strong></div>
      </li>`;
    }).join('');
    return `<ul>${lis}</ul>`;
  }

  function lookup(){
    const input=document.getElementById('query').value||'';
    const out=document.getElementById('results'); out.innerHTML='';
    const q=normalize(input); if(!q){ out.innerHTML='<span class="muted">Type something to searchâ€¦</span>'; return; }
    if(cacheHTML[q]){ out.innerHTML=cacheHTML[q]; return; }

    let exact=null;
    for(let i=0;i<entries.length;i++){const e=entries[i]; if(equalLoose(e.code,input)||equalLoose(e.name,input)){exact=e;break;}}

    let html='';

    if(/^[0-9]+$/.test(q)){
      if(exact){
        const [src1,src2]=imgCandidates(exact.code,exact.name); const ph=placeholderData(exact.name);
        html+=`<div class="card"><img class="thumb" src="${src1}" alt="${exact.name}" loading="lazy" decoding="async" data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)"><div class="meta"><strong>âœ… Exact Match: ${exact.code} â€“ ${exact.name}</strong></div></div>`;
      } else { html+='<div><strong>No exact code match</strong></div>'; }
      const partial=[]; for(let k=0;k<entries.length;k++){const e2=entries[k]; if(exact&&e2.code===exact.code)continue; if(e2.code.indexOf(q)!==-1)partial.push(e2);}
      if(partial.length){ partial.sort((a,b)=>(a.code.indexOf(q)-b.code.indexOf(q))||a.code.localeCompare(b.code)); html+=`<div class="muted"><strong>Other Related Matches:</strong>${renderList(partial.slice(0,20))}</div>`; }
      out.innerHTML=html; cacheHTML[q]=html; return;
    }

    const qTokens=toTokens(q), qTokSet=qTokens.reduce((o,t)=>(o[t]=1,o),{}), qSndx=qTokens.map(soundex);
    const famCanonSet=Object.create(null); for(const term of qTokens){const canon=FAMILY.toCanonical[term]; if(canon)famCanonSet[canon]=1;}
    const hasFam=Object.keys(famCanonSet).length>0;

    const candIdx=new Set(); qTokens.forEach(t=>(POSTINGS.get(t)||[]).forEach(i=>candIdx.add(i)));
    if(hasFam){ Object.keys(famCanonSet).forEach(fam=>{ const arr=FAMILY_INDEX[fam]; if(arr)arr.forEach(i=>candIdx.add(i)); }); }
    const pool=candIdx.size?Array.from(candIdx).map(i=>entries[i]):entries;

    const scored=[]; for(const en of pool){
      if(exact&&en.code===exact.code)continue;
      let s=fastScore(en,q,qTokens,qTokSet,qSndx);
      if(hasFam){ const itemFam=inferFamily(en); if(itemFam&&famCanonSet[itemFam]) s+=0.6; }
      if(/[0-9]/.test(q)){ const digits=q.replace(/\D/g,''); if(digits&&en.code.indexOf(digits)!==-1) s=Math.max(s,0.4); }
      if(s>=0.25) scored.push({ref:en,s});
    }
    scored.sort((a,b)=>b.s-a.s);
    const top=scored.slice(0,60); for(let i=0;i<top.length;i++){ top[i].s=0.5*top[i].s+0.5*scoreNameLoose(top[i].ref.name,input); }
    top.sort((a,b)=>b.s-a.s);

    if(!top.length&&hasFam){
      const famOnly=[]; for(const ee of entries){ const famZ=inferFamily(ee); if(famZ&&famCanonSet[famZ]) famOnly.push(ee); }
      if(famOnly.length){ html+='<div><strong>No exact code/name match</strong></div>'; html+=`<div class="muted"><strong>By family:</strong>${renderList(famOnly.slice(0,20))}</div>`; out.innerHTML=html; cacheHTML[q]=html; return; }
    }

    if(exact){
      const [src1,src2]=imgCandidates(exact.code,exact.name); const ph=placeholderData(exact.name);
      html+=`<div class="card"><img class="thumb" src="${src1}" alt="${exact.name}" loading="lazy" decoding="async" data-alt="${src2}" data-ph="${ph}" onerror="__imgFallback(this)"><div class="meta"><strong>âœ… Exact Match: ${exact.code} â€“ ${exact.name}</strong></div></div>`;
    } else { html+='<div><strong>No exact code/name match</strong></div>'; }

    if(top.length){ const list=top.slice(0,15).map(m=>m.ref); html+=`<div class="muted"><strong>Other Related Matches:</strong>${renderList(list)}</div>`; }

    out.innerHTML=html; cacheHTML[q]=html;
  }

  /* debounce type */
  function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
  const onType=debounce(()=>{const v=document.getElementById('query').value.trim(); if(/^\d+$/.test(v)||v.length>=2){lookup();}},220);
  document.getElementById('btn').addEventListener('click',lookup);
  document.getElementById('query').addEventListener('keydown',e=>{if(e.key==='Enter')lookup();});
  document.getElementById('query').addEventListener('input',onType);

  /* ===== A2HS detection + keyboard trampoline ===== */
  (function(){
    var isStandalone = window.navigator.standalone ||
                       (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
    if (!isStandalone) { document.getElementById('query').focus(); return; }

    document.documentElement.classList.add('ios-standalone');

    var q = document.getElementById('query');
    if (!q) return;

    // Create a tiny offscreen input that reliably opens the keyboard
    var tramp = document.createElement('input');
    tramp.type = 'text';
    tramp.autocapitalize = 'off';
    tramp.autocomplete = 'off';
    tramp.style.position = 'fixed';
    tramp.style.bottom = '-100px';
    tramp.style.left = '0';
    tramp.style.opacity = '0';
    tramp.style.width = '1px';
    tramp.style.height = '1px';
    tramp.setAttribute('aria-hidden','true');
    document.body.appendChild(tramp);

    function unlock(){
      tramp.focus();
      setTimeout(function(){
        q.focus({preventScroll:false});
        try { q.setSelectionRange(q.value.length, q.value.length); } catch(_) {}
        q.scrollIntoView({block:'center', inline:'nearest'});
      }, 0);
      q.removeEventListener('pointerdown', unlock, true);
      q.removeEventListener('click', unlock, true);
      q.removeEventListener('touchend', unlock, true);
      setTimeout(function(){ tramp.remove(); }, 250);
    }

    q.addEventListener('pointerdown', unlock, true);
    q.addEventListener('click', unlock, true);
    q.addEventListener('touchend', unlock, true);
  })();
</script>
</body>
</html>
